---
title: 混合云中的 MySQL 备份实战
author: Mingshi
date: 2020-07-22
---

## 步骤

### 备份

1. 在路由器上连接到 VPN
2. 在腾讯云 VPN 服务器上设置路由表，使其可以访问到 LAN 上的 Mysql 服务器
3. 在腾讯云 VPN 服务器上设置 Nginx 反向代理 LAN 的 Mysql 服务器
4. （可选）在本地创建用于备份的 mysql 账户，需要`replication`, `slave`权限
5. 本地测试通过腾讯云 VPN 服务器的公网 ip + nginx 设置的端口号连接本地 mysql 服务器
6. 若连接不成功，请检查 nginx 配置和 vpn 连接是否正常
7. 在阿里云上购买`数据库备份DBS`
8. 设置备份计划，设置备份源为腾讯云上的 VPN 服务器的公网 ip + nginx 上设置的端口号
9. 启动备份计划，包括全量备份和增量备份

第 3 步中 Nginx 配置文件 `/etc/nginx/nginx.conf`，一般是这个。注意通过 `stream` 而不是 `http`，具体文件内容：

```
http {
    ...
}

stream {
    upstream mysql_lan_106 {
        server 192.168.0.106:3306;
    }

    server {
        listen 33060;
        proxy_pass mysql_lan_106;
    }
}

```

更新后，运行 `sudo nginx -s reload` 来重启 nginx。

### 恢复

在阿里云 dbs 中选择`恢复任务`，设置恢复全量+增量的备份，设置目的数据库为已经可以通过腾讯云主机上搭建的 VPN 访问的本地 Mysql 服务器，配置已经有合适权限的账号。在启动恢复任务前会检查，如果出错，按照提示配置即可。

### 注意

1. 阿里云的备份计划只能同时备份一个源数据库；
2. 保持 VPN 连接。阿里云会在一定时间内尝试重新连接源/目的数据库，超时后任务失败，无法断点续传；
3. 可以通过有公网 ip 的 VPN 服务器反向代理本地的任意 Mysql 服务。

## 实际备份测试

购买的是一个月的 small 版的逻辑备份计划，花费 140 元，包含 400GB/月 的流量，超出的流量 0.35 元/GB，单独购买存储包无法进行备份，但可以抵扣超出的流量（貌似）。

备份：测试备份和恢复 106 数据库上的 finance 库，传输速度约为 1MB/s 左右，备份耗时大约 1 小时，备份大小 23.63GB。
恢复：

## 不可行的方案

### 使用腾讯云 mysql 实例进行主从或双主备份

- 腾讯云 mysql 实例的账号没有权限用来配置 master/slave

## 参考资料
