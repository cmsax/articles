<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/articles/img/favicon.png"><title>Solve Pickle Issue When Using Function with Decorator in Multiprocessing</title><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/articles/atom.xml" title="Articles" type="application/atom+xml">
</head><body>　　<div class="inner"><h2>Solve Pickle Issue When Using Function with Decorator in Multiprocessing</h2><h2 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a>Issue</h2><p>Exceptions raised below when I tried to use function with function decorator in multiprocessing.</p>
<h3 id="My-Decorator"><a href="#My-Decorator" class="headerlink" title="My Decorator"></a>My Decorator</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>(<span class="params">retry=<span class="number">5</span>, with_client=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">        @wraps</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            <span class="keyword">nonlocal</span> retry</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> with_client:</span><br><span class="line">                        client = InfluxDBClient(**kwargs[<span class="string">&#x27;influx_option&#x27;</span>])</span><br><span class="line">                        func(client, *args, **kwargs)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        func(*args, **kwargs)</span><br><span class="line">                <span class="keyword">except</span> Queue.empty:</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">if</span> retry &lt; <span class="number">0</span>:</span><br><span class="line">                        print(<span class="string">&#x27;Exit &#123;&#125; after retry.&#x27;</span>.<span class="built_in">format</span>(func.__name__))</span><br><span class="line">                    retry -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">except</span> Queue.full:</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(<span class="string">&#x27;Exception raised in &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(func.__name__))</span><br><span class="line">                    print(<span class="built_in">str</span>(e))</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>

<p>I use this decorator function this way:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapped(<span class="params"><span class="number">4</span></span>)</span></span><br><span class="line">run(arg):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">Process(target=run, args=(<span class="string">&#x27;test&#x27;</span>,)).start()</span><br></pre></td></tr></table></figure>

<h3 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1st error</span></span><br><span class="line">AttributeError: Can<span class="string">&#x27;t pickle local object &#x27;</span>wrapped.&lt;locals&gt;.decorator.&lt;locals&gt;.wrapper<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 2nd error</span></span><br><span class="line"><span class="string">EOFError: Ran out of input</span></span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>The reason this happens is that a wrapped function with function decorator is not <code>picklable</code>, which means the wrapped function is not serializable when passed to <code>Process()</code>, view <a target="_blank" rel="noopener" href="http://ralph-wang.github.io/blog/2015/02/15/zhuang-shi-qi-yu-duo-jin-cheng-yi-ji-pickle/">this blog</a>(language: zh-CN).</p>
<p>You can implement a decorator class to return a <code>picklable</code> object instead of decorator function.</p>
<h3 id="My-New-Decorator"><a href="#My-New-Decorator" class="headerlink" title="My New Decorator"></a>My New Decorator</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wrapped</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, retry=<span class="number">5</span>, with_client=<span class="literal">False</span></span>):</span></span><br><span class="line">        self.retry = retry</span><br><span class="line">        self.with_client = with_client</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, func</span>):</span></span><br><span class="line"><span class="meta">        @wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.with_client:</span><br><span class="line">                        client = InfluxDBClient(**kwargs[<span class="string">&#x27;influx_option&#x27;</span>])</span><br><span class="line">                        func(client=client, *args, **kwargs)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        func(*args, **kwargs)</span><br><span class="line">                <span class="keyword">except</span> Queue.empty:</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">if</span> retry &lt; <span class="number">0</span>:</span><br><span class="line">                        print(<span class="string">&#x27;Exit &#123;&#125; after retry.&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                            func.__name__</span><br><span class="line">                        ))</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    retry -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">except</span> Queue.full:</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(<span class="string">&#x27;Exception raised in &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                        func.__name__</span><br><span class="line">                    ))</span><br><span class="line">                    print(<span class="built_in">str</span>(e))</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>

<p>Now, we use the decorator class this way:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Wrapped(<span class="params"><span class="number">4</span>, <span class="literal">True</span></span>)</span></span><br><span class="line">run(arg):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">Process(target=run, args=(arg, ))</span><br></pre></td></tr></table></figure>

<hr><p><span>↶ </span><a href="/">返回首页</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>