<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/articles/img/favicon.png"><title>Integrate InfluxDB Service in GitLab CI</title><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/articles/atom.xml" title="Articles" type="application/atom+xml">
</head><body>　　<div class="inner"><h2>Integrate InfluxDB Service in GitLab CI</h2><p>The services keyword defines a Docker image that runs during a job linked to the Docker image that the image keyword defines. This allows you to access the service image during build time.</p>
<p>The service image can run any application, but the most common use case is to run a database container, for example:</p>
<ul>
<li>MySQL/PostgreSQL/SQLServer</li>
<li>Redis</li>
</ul>
<p>GitLab didn’t provide an official document for InfluxDB, it still needs to configure though a <code>service</code> is just an image.</p>
<p>According to <a target="_blank" rel="noopener" href="https://hub.docker.com/_/influxdb">InfluxDB’s official docker image</a>, we need to set a few envrionment variables, such as:</p>
<ul>
<li>INFLUXDB_DB: for initializing db</li>
<li>INFLUXDB_ADMIN_USER: for write/read data, relies on the var above</li>
</ul>
<p>I add a service to a job, following <code>.gitlab-ci.yml</code> describes it:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Execute via shell</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">influxdb:latest</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">INFLUXDB_DB:</span> <span class="string">&quot;transaction_test&quot;</span></span><br><span class="line">  <span class="attr">INFLUX_DB_HOST:</span> <span class="string">&quot;http://localhost:8086&quot;</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>However, <code>Connection Refused</code> errors occurred when I tried to dial TCP to <code>localhost</code> on port <code>8086</code> through shell executor in GitLab CI. Port <code>8086</code> is influxdb docker image’s default HTTP API port.<br>When defining a <code>mysql</code> or <code>redis</code> service, no port was described in yaml file, and I successfully connected to <code>mysql</code> service via<br><code>localhost:3306</code>. Is there any difference between these images?</p>
<p>The <code>mysql</code> image bind port <code>3306</code> by default, yet <code>influxdb</code> has not. Besides, GitLab does not support port mapping in CI <code>service</code>. There is an <a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-runner/issues/2460">issue</a> about port mapping in CI <code>service</code>, but it’s still WIP after 2 years.</p>
<p>To debug, we can run our job on local gitlab-runner, and add <code>tail -F /dev/null</code> line before the part where our script fails, this will hault the job for 30 minutes. While it hangs, we can attach to the container wit <code>docker exec -it container-name /bin/sh</code> to see what happens. But I’d not try this.</p>
<p>Finally, I found that the executor was randomly <code>Docker executor</code> and <code>Kubernetes executor</code>. The address is different in different executor.<br>In <code>Docker executor</code>, its own dns service will resolve the service name to a typical ip address. However in <code>K8S executor</code> you must link to the service via exact ip address, such as <code>localhost</code> or <code>127.0.0.1</code>.</p>
<p>Then I just add a tag to the job, it works. GitLab CI will automatically publish the <code>EXPOSEd</code> port in the image’s <code>Dockerfile</code>.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes</span></span><br></pre></td></tr></table></figure>
<hr><p><span>↶ </span><a href="/">返回首页</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>