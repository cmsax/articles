<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/articles/img/favicon.png"><title>混合云中的 MySQL 备份实战</title><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/articles/atom.xml" title="Articles" type="application/atom+xml">
</head><body>　　<div class="inner"><h2>混合云中的 MySQL 备份实战</h2><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><ol>
<li>在路由器上连接到 VPN</li>
<li>在腾讯云 VPN 服务器上设置路由表，使其可以访问到 LAN 上的 Mysql 服务器</li>
<li>在腾讯云 VPN 服务器上设置 Nginx 反向代理 LAN 的 Mysql 服务器</li>
<li>（可选）在本地创建用于备份的 mysql 账户，需要<code>replication</code>, <code>slave</code>权限</li>
<li>本地测试通过腾讯云 VPN 服务器的公网 ip + nginx 设置的端口号连接本地 mysql 服务器</li>
<li>若连接不成功，请检查 nginx 配置和 vpn 连接是否正常</li>
<li>在阿里云上购买<code>数据库备份DBS</code></li>
<li>设置备份计划，设置备份源为腾讯云上的 VPN 服务器的公网 ip + nginx 上设置的端口号</li>
<li>启动备份计划，包括全量备份和增量备份</li>
</ol>
<p>第 3 步中 Nginx 配置文件 <code>/etc/nginx/nginx.conf</code>，一般是这个。注意通过 <code>stream</code> 而不是 <code>http</code>，具体文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    upstream mysql_lan_106 &#123;</span><br><span class="line">        server 192.168.0.106:3306;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 33060;</span><br><span class="line">        proxy_pass mysql_lan_106;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更新后，运行 <code>sudo nginx -s reload</code> 来重启 nginx。</p>
<h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3><p>在阿里云 dbs 中选择<code>恢复任务</code>，设置恢复全量+增量的备份，设置目的数据库为已经可以通过腾讯云主机上搭建的 VPN 访问的本地 Mysql 服务器，配置已经有合适权限的账号。在启动恢复任务前会检查，如果出错，按照提示配置即可。</p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol>
<li>阿里云的备份计划只能同时备份一个源数据库；</li>
<li>保持 VPN 连接。阿里云会在一定时间内尝试重新连接源/目的数据库，超时后任务失败，无法断点续传；</li>
<li>可以通过有公网 ip 的 VPN 服务器反向代理本地的任意 Mysql 服务。</li>
</ol>
<h2 id="实际备份测试"><a href="#实际备份测试" class="headerlink" title="实际备份测试"></a>实际备份测试</h2><p>购买的是一个月的 small 版的逻辑备份计划，花费 140 元，包含 400GB/月 的流量，超出的流量 0.35 元/GB，单独购买存储包无法进行备份，但可以抵扣超出的流量（貌似）。</p>
<p>备份：测试备份和恢复 106 数据库上的 finance 库，传输速度约为 1MB/s 左右，备份耗时大约 1 小时，备份大小 23.63GB。<br>恢复：</p>
<h2 id="不可行的方案"><a href="#不可行的方案" class="headerlink" title="不可行的方案"></a>不可行的方案</h2><h3 id="使用腾讯云-mysql-实例进行主从或双主备份"><a href="#使用腾讯云-mysql-实例进行主从或双主备份" class="headerlink" title="使用腾讯云 mysql 实例进行主从或双主备份"></a>使用腾讯云 mysql 实例进行主从或双主备份</h3><ul>
<li>腾讯云 mysql 实例的账号没有权限用来配置 master/slave</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><hr><p><span>↶ </span><a href="/">返回首页</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>