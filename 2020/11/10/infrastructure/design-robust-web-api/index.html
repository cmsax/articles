<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/articles/img/favicon.png"><title>设计健壮和幂等的 Web API</title><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/articles/atom.xml" title="Articles" type="application/atom+xml">
</head><body>　　<div class="inner"><h2>设计健壮和幂等的 Web API</h2><p>网络和服务端的问题都会导致 API 出错, 解决这个问题需要遵循 3 个原则:</p>
<ol>
<li>网络故障后, 客户端需要重新发送请求来保持一致性</li>
<li>客户端因为网络故障重新发送的请求需要保持幂等性, 也就是说需要带上一个用于保持幂等的 id<ol>
<li>在 RESTful API 中, PUT, GET, DELETE 这些动词都具有幂等性</li>
<li>POST 不能保持幂等, 因此需要使用一个键 id 来区分请求. 这个键是这样用的:<ol>
<li>如果客户端这一侧在发请求前失败了, 重发后对于服务端来说是透明的, 不存在什么问题</li>
<li>如果客户端发请求到服务端后, 服务端处理时出错了, 那么需要数据库具备 ACID 特性, 将处理包装成事务即可. 失败了就标记该 id 并返回错误.</li>
<li>如果服务端事务处理成功了, 但响应没能到达客户端, 那么客户端会重发请求, 服务端只需要根据 id 将缓存的结果返回即可</li>
</ol>
</li>
</ol>
</li>
<li>同时, 需要避免客户端重新发送请求的频率, 避免请求阻塞.</li>
</ol>
<hr><p><span>↶ </span><a href="/">返回首页</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>